name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  merge_group:  # Required for merge queue support
  workflow_dispatch:  # Manual trigger for testing

# Prevent duplicate runs, cancel stale builds when new commits arrive
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Explicit permissions for security (principle of least privilege)
# Note: Add `id-token: write` when Azure OIDC deployment is implemented
# See: https://learn.microsoft.com/en-us/azure/developer/github/connect-from-azure-openid-connect
permissions:
  contents: read
  packages: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
    steps:
      # SHA-pinned for supply chain security
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: Setup .NET
        uses: actions/setup-dotnet@baa11fbfe1d6520db94683bd5c7a3818018e4309  # v5.1.0
        with:
          global-json-file: global.json
          cache: true
          cache-dependency-path: '**/packages.lock.json'

      - name: Check for solution files
        id: check-sln
        uses: ./.github/actions/check-solution

      - name: Restore dependencies
        if: steps.check-sln.outputs.has_solution == 'true'
        run: dotnet restore Medley.slnx

      - name: Build
        if: steps.check-sln.outputs.has_solution == 'true'
        run: dotnet build Medley.slnx --no-restore --configuration Release

      - name: Test
        if: steps.check-sln.outputs.has_solution == 'true'
        run: dotnet test Medley.slnx --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=test-results.trx" --collect:"XPlat Code Coverage"

      - name: Upload test results
        if: always() && steps.check-sln.outputs.has_solution == 'true'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: test-results
          path: '**/test-results.trx'
          retention-days: 7

      - name: Upload coverage reports
        if: always() && steps.check-sln.outputs.has_solution == 'true'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: coverage-reports
          path: '**/coverage.cobertura.xml'
          retention-days: 7

      - name: Warn if no solution
        if: steps.check-sln.outputs.has_solution != 'true'
        run: echo "::warning::No solution file found - build and tests were skipped"
